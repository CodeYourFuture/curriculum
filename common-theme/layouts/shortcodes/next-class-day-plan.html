{{/* Compute link to next class day plan */}}
{{ $weekdays := dict "Sunday" 0 "Monday" 1 "Tuesday" 2 "Wednesday" 3 "Thursday" 4 "Friday" 5 "Saturday" 6 }}

{{/* Resolve base time: prefer .Page.Date (shortcode context), else .Date, else now */}}
{{ $now := now }}
{{ with .Page }}
  {{ with .Date }}
    {{ $now = . }}
  {{ end }}
{{ else }}
  {{ with .Date }}
    {{ $now = . }}
  {{ end }}
{{ end }}

{{ $todayIdx := index $weekdays ($now.Format "Monday") }}
{{ $daysUntilSat := mod (add (sub 6 $todayIdx) 7) 7 | int }}
{{ $nextClass := $now.AddDate 0 0 $daysUntilSat }}

{{ $year := int ($nextClass.Format "2006") }}
{{ $month := int ($nextClass.Format "1") }}
{{ $quarterMonth := add (mul (div (sub $month 1) 3) 3) 1 }}
{{ $start := time (printf "%04d-%02d-01" $year $quarterMonth) }}
{{ $startIdx := index $weekdays ($start.Format "Monday") }}
{{ $daysToSat := mod (add (sub 6 $startIdx) 7) 7 | int }}
{{ $courseStart := $start.AddDate 0 0 $daysToSat }}

{{ $startUnix := $courseStart.Unix }}
{{ $classUnix := $nextClass.Unix }}
{{ $daysFromStart := div (sub $classUnix $startUnix) 86400 }}
{{ $sprint := add 1 (div $daysFromStart 7) }}

{{/* Gather day plan pages within the current module */}}
{{ $module := .Page.CurrentSection }}
{{ $dayPlans := sort (where $module.Pages "Params.menu_level" "intersect" (slice "module")) "Weight" }}

{{ with index $dayPlans (sub $sprint 1) }}
  <a href="{{ .RelPermalink }}">Day plan for sprint {{ $sprint }}</a>
{{ else }}
  <span>Day plan coming soon</span>
{{ end }}
