{{ $blockData := .Page.Scratch.Get "blockData" }}

{{ $pageContext := . }}
{{ $response := resources.GetRemote $blockData.api $blockData.headers }}

{{/* 404s lead to GetRemote returning nil rather than an error. */}}
{{ if eq $response nil }}
  {{ errorf "Couldn't find readme at %s" $blockData.api }}
{{ end }}

{{ $pageTitle := .Page.Title }}

{{ with $response }}
  {{ with .Err }}
    {{ errorf "Failed %s on %s. Error: %s" $blockData.api $pageTitle . }}
  {{ end }}

  {{ $response := .Content | unmarshal }}
  {{ $decodedContent := $response.content | base64Decode }}
  <section
    class="c-block c-block--{{ $blockData.type }}"
    aria-labelledby="{{ $blockData.name |urlize }}">
    <header class="c-block__header">
      <h2
        class="c-block__title e-heading__2"
        id="{{ $blockData.name |urlize }}">
        <a href="{{ $response.html_url }}">üîó {{ $blockData.name }}</a>
      </h2>
      {{ partial "time.html" $pageContext }}
    </header>
    {{ $extractedObjectives := partial "strings/extract-github-objectives.html" (dict "URL" $blockData.api "body" $decodedContent) }}
    {{ if gt (len $extractedObjectives) 0 }}
      <details open>
        <summary><h3 class="e-heading__5">Learning Objectives</h3></summary>
        {{ partial "objectives/block" $extractedObjectives }}
      </details>
    {{ end }}
    <div class="c-block__content c-copy">
      {{ $strippedComments := $decodedContent | replaceRE "<!--(.*?)-->" "$1" }}
      {{ $externalPath := replace $response.download_url $response.name "" }}
      {{/* TODO this replaces the call to the absolute-image-paths partial as it was breaking the markdownifying --
        once this regex happened in another partial, it no longer recognised hugo shortcodes
        if you can fix this and return the partial call PLEASE do, as I don't want multiple regexes littering the codebase
      */}}
      {{/* Replace Markdown image links, targeting anything without a : */}}
      {{ $processedContent := $strippedComments | replaceRE `!\[([^\]]+)\]\(([^"http:\/\/|https:\/\/][^)]+)\)` (printf "![$1](%s$2)" $externalPath) }}
      {{ $textWithoutObjectives := partial "strings/remove-github-objectives.html" $processedContent }}
      {{ $textWithoutObjectives | page.RenderString }}

    </div>

    {{/* You can attach a range of nested blocks as options
      It can be quite a lot of content so it comes in accordions
    */}}
    {{ with $blockData.hasBlocks }}
      <section class="c-block__nested">
        <h3>üóÇÔ∏è Related</h3>
        {{ range . }}
          {{ range $block := . }}
            {{ $blockDict := dict "block" $block "Page" $.Page "Site" site }}
            {{ partial "block/nested.html"  $blockDict }}
          {{ end }}
        {{ end }}
      </section>
    {{ end }}
  </section>
{{ end }}
