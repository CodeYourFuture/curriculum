{{/* https://gohugo.io/methods/page/resources/#get */}}
{{ if eq .Destination "" }}
  {{ warnf "Image source is empty: %s" .PlainText }}
{{ else }}
  {{ $src := .Destination }}
  {{ $alt := .PlainText | safeHTML }}
  {{ $caption := "" }}
  {{ $image := false }}
  {{ $srcset := "" }}
  {{ with .Title }}
    {{ $caption = . | safeHTML }}
  {{ end }}
  {{/* Check if the source is external to this repo */}}
  {{ $isRemote := or (strings.HasPrefix $src "http://") (strings.HasPrefix $src "https://") }}

  {{/* Case 1: where an image is remote, get it please */}}
  {{- if $isRemote -}}
    {{/* Most images will be github, and we were previously using jsdelivr, but now let's use github raw */}}
    {{ if in $src "github.com" }}
      {{/* Replace 'blob' or 'tree' with a direct path for raw content */}}
      {{ $src = replace $src "github.com" "raw.githubusercontent.com" }}
      {{ $src = replaceRE "/(blob|tree)/" "/" $src }}
    {{ end }}

    {{ with resources.GetRemote $src }}
      {{ $image = . }}
    {{ else }}
      {{ warnf "Unable to get remote resource %q" $src }}
    {{ end }}
  {{ end }}

  {{/* Case 2: if it's not an external link, look for the image in Page resources */}}
  {{ if not $isRemote }}
    {{/* Check if the image is a resource */}}
    {{ with $.Page.Resources.GetMatch (printf "%s" $src) }}
      {{ $image = . }}
    {{ end }}
  {{ end }}

  {{/* Case 3: If the image is still not found, try to get it from the assets directory */}}
  {{- if and (not $image) (not $isRemote) -}}
    {{ $path := (path.Join "custom-images" $src) }}
    {{ with resources.Get $path }}
      {{ $image = . }}
    {{ end }}
  {{- end -}}

  {{/* If the image is found, resize it based on the screen width and display it in the figure */}}
  {{ if $image }}

    {{/* Perform resizing operations only if $image is a rasterisable resource */}}
    {{ if and (ne $image.MediaType.SubType "svg")  (ne $image.MediaType.SubType ".gif") }}
      {{ $small := (cond (gt $image.Width 480) ($image.Resize "480x webp q75") $image) }}
      {{ $medium := (cond (gt $image.Width 768) ($image.Resize "768x webp q75") $image) }}
      {{ $big := (cond (gt $image.Width 1024) ($image.Resize "1024x webp q75") $image) }}
      {{ $srcset := printf "%s 480w, %s 768w, %s 1024w" $small.RelPermalink $medium.RelPermalink $big.RelPermalink }}
    {{ else }}
      {{/* If $image isn't rasterisable, don't try to generate srcset */}}
      {{ $srcset := $image.RelPermalink }}
    {{ end }}


    <figure>
      <img
        loading="lazy"
        src="{{ $image.RelPermalink }}"
        srcset="{{ $srcset }}"
        sizes="(max-width: 480px) 480px, (max-width: 768px) 768px, 1024px"
        width="{{ $image.Width }}"
        height="{{ $image.Height }}"
        alt="{{ if $alt }}
          {{ $alt }}
        {{ else }}
          &nbsp;
        {{ end }}" />
      {{ with $caption }}
        <figcaption>{{ . | markdownify }}</figcaption>
      {{ end }}
    </figure>
  {{ else }}
    <div
      title="broken image link from {{ $src }}"
      style="font-size: 48px; text-align: center;">
      üñºÔ∏è
    </div>
  {{ end }}
{{ end }}
